# üê≥ Docker Setup Complet : Laravel + Supabase PostgreSQL

## üì¶ Les 4 Fichiers √† Cr√©er

### 1Ô∏è‚É£ **Dockerfile** (Laravel + PHP-FPM)

Cr√©e `Dockerfile` √† la racine du projet Laravel :

```dockerfile
# ============================================
# √âTAPE 1 : Image de base PHP 8.2
# ============================================
FROM php:8.2-fpm-alpine

# ============================================
# √âTAPE 2 : Installer les d√©pendances syst√®me
# ============================================
RUN apk add --no-cache \
    curl \
    git \
    grep \
    libpng-dev \
    libjpeg-turbo-dev \
    libfreetype6-dev \
    postgresql-dev \
    zip \
    unzip \
    supervisor \
    nginx

# ============================================
# √âTAPE 3 : Installer les extensions PHP
# ============================================
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) \
    gd \
    pdo \
    pdo_pgsql \
    bcmath \
    ctype \
    fileinfo \
    json \
    mbstring \
    tokenizer

# ============================================
# √âTAPE 4 : Installer Composer
# ============================================
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# ============================================
# √âTAPE 5 : Configurer le r√©pertoire de travail
# ============================================
WORKDIR /app

# ============================================
# √âTAPE 6 : Copier les fichiers du projet
# ============================================
COPY . .

# ============================================
# √âTAPE 7 : Installer les d√©pendances PHP
# ============================================
RUN composer install --no-dev --optimize-autoloader

# ============================================
# √âTAPE 8 : D√©finir les permissions
# ============================================
RUN chown -R www-data:www-data /app/storage /app/bootstrap/cache

# ============================================
# √âTAPE 9 : Exposer le port
# ============================================
EXPOSE 8000

# ============================================
# √âTAPE 10 : Commande de d√©marrage
# ============================================
CMD ["php", "artisan", "serve", "--host=0.0.0.0", "--port=8000"]
```

---

### 2Ô∏è‚É£ **docker-compose.yml** (Orchestration)

Cr√©e `docker-compose.yml` √† la racine :

```yaml
version: '3.9'

services:
  # ============================================
  # APPLICATION LARAVEL
  # ============================================
  laravel:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: faceauth-laravel
    ports:
      - "8001:8000"
    environment:
      # Application
      - APP_NAME=FaceAuth Backend
      - APP_ENV=production
      - APP_DEBUG=false
      - APP_URL=http://localhost:8001
      - APP_TIMEZONE=UTC
      - APP_LOCALE=fr
      
      # Base de donn√©es PostgreSQL (Supabase)
      - DB_CONNECTION=pgsql
      - DB_HOST=supabase-db
      - DB_PORT=5432
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      
      # API Python FaceAuth
      - FACEAUTH_API_URL=http://faceauth-api:8000
      - FACEAUTH_API_TIMEOUT=30
      
      # Cache & Session
      - CACHE_DRIVER=redis
      - SESSION_DRIVER=redis
      - QUEUE_CONNECTION=redis
      - REDIS_HOST=redis
      - REDIS_PASSWORD=null
      - REDIS_PORT=6379
      
      # Mail
      - MAIL_MAILER=log
      
      # Logs
      - LOG_CHANNEL=stack
      - LOG_LEVEL=debug
    
    volumes:
      - .:/app
      - /app/node_modules
      - /app/vendor
    
    depends_on:
      - redis
    
    networks:
      - faceauth-network
    
    restart: unless-stopped

  # ============================================
  # REDIS (Cache & Sessions)
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: faceauth-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - faceauth-network
    restart: unless-stopped

  # ============================================
  # API PYTHON FACEAUTH
  # ============================================
  faceauth-api:
    image: faceauth-api:latest
    container_name: faceauth-python-api
    ports:
      - "8000:8000"
    environment:
      - VISION_SECRET_PART1=${VISION_SECRET_PART1}
      - VISION_SECRET_PART2=${VISION_SECRET_PART2}
      - MODEL_NAME=buffalo_l
      - MODEL_CONTEXT_ID=-1
      - ENVIRONMENT=production
    volumes:
      - insightface-cache:/root/.insightface
    networks:
      - faceauth-network
    restart: unless-stopped

networks:
  faceauth-network:
    driver: bridge

volumes:
  redis-data:
  insightface-cache:
```

---

### 3Ô∏è‚É£ **.env.production** (Secrets pour Render/Production)

Cr√©e `.env.production` (NE PAS commiter) :

```dotenv
# ============================================
# APPLICATION
# ============================================
APP_NAME="FaceAuth Backend"
APP_ENV=production
APP_KEY=base64:DkVB0Vf1SUaAdEvD2wX3oNvEr54F6FXDy0eMx1LlspA=
APP_DEBUG=false
APP_URL=https://ton-domaine.com
APP_TIMEZONE=UTC
APP_LOCALE=fr
APP_FALLBACK_LOCALE=fr

# ============================================
# SUPABASE PostgreSQL (√Ä r√©cup√©rer sur Supabase)
# ============================================
DB_CONNECTION=pgsql
DB_HOST=db.XXXXXXX.supabase.co
DB_PORT=5432
DB_DATABASE=postgres
DB_USERNAME=postgres
DB_PASSWORD=ta_password_super_secrete_ici
DB_SSLMODE=require

# ============================================
# FACEAUTH PYTHON API
# ============================================
FACEAUTH_API_URL=https://vision-afrique-ethique-python3.onrender.com
FACEAUTH_API_TIMEOUT=30

# ============================================
# CACHE & SESSION (Redis si utilis√©)
# ============================================
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=null

# ============================================
# SECRETS FACEAUTH PYTHON
# ============================================
VISION_SECRET_PART1=votre_secret_1_minimum_32_chars
VISION_SECRET_PART2=votre_secret_2_minimum_32_chars

# ============================================
# MAIL
# ============================================
MAIL_MAILER=log
MAIL_FROM_ADDRESS="hello@example.com"
MAIL_FROM_NAME="${APP_NAME}"

# ============================================
# LOGS
# ============================================
LOG_CHANNEL=stack
LOG_LEVEL=debug
```

---

### 4Ô∏è‚É£ **.dockerignore** (Fichiers √† exclure)

Cr√©e `.dockerignore` √† la racine :

```
.git
.gitignore
.env
.env.*.local
*.log
node_modules
vendor
storage/logs
bootstrap/cache
tests
.vscode
.idea
*.swp
*.swo
.DS_Store
README.md
```

---

## üöÄ √âtapes pour D√©ployer

### **√âtape 1 : Configurer Supabase**

1. Va sur https://supabase.com
2. Cr√©e un nouveau projet
3. R√©cup√®re les infos :
   - Host: `db.XXXXXXX.supabase.co`
   - Port: `5432`
   - Database: `postgres`
   - Username: `postgres`
   - Password: (g√©n√©r√©e automatiquement)

### **√âtape 2 : Tester en Local**

```bash
# 1. Cr√©e le Dockerfile et docker-compose.yml
# 2. Build l'image Laravel
docker build -t faceauth-laravel:latest .

# 3. Lance tout (Laravel + Redis + API Python)
docker-compose up -d

Pour relanacer
`docker-compose up --build -d`

Relance

`docker build --no-cache -t faceauth-laravel:latest .`
`docker run -p 8001:8000 --env-file .env faceauth-laravel:latest`


# 4. Initialise la base de donn√©es
docker-compose exec laravel php artisan migrate --force
docker-compose exec laravel php artisan db:seed

# 5. V√©rifie que tout marche
curl http://localhost:8001
curl http://localhost:8000/health
```

### **√âtape 3 : Migrations et Seeders**

Cr√©e `database/migrations/2024_01_01_000000_create_faces_table.php` :

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('faces', function (Blueprint $table) {
            $table->id();
            $table->foreignId('user_id')->constrained()->cascadeOnDelete();
            $table->string('token')->unique();
            $table->json('embedding')->nullable();
            $table->integer('age')->nullable();
            $table->string('gender')->nullable();
            $table->timestamps();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('faces');
    }
};
```

Cr√©e `database/seeders/DatabaseSeeder.php` :

```php
<?php

namespace Database\Seeders;

use App\Models\User;
use Illuminate\Database\Seeder;

class DatabaseSeeder extends Seeder
{
    public function run(): void
    {
        // Cr√©e un utilisateur de test
        User::factory()->create([
            'name' => 'Test User',
            'email' => 'test@example.com',
        ]);
    }
}
```

### **√âtape 4 : Deployer sur Render**

1. **Connecte ton repo GitHub √† Render**
2. **Cr√©e un nouveau Web Service**
3. **Configure les variables d'environnement** :
   - `DB_HOST`: Host Supabase
   - `DB_PASSWORD`: Password Supabase
   - `APP_KEY`: G√©n√®re avec `php artisan key:generate`
   - Tous les secrets de `.env.production`

4. **Deploy** !

---

## üîÑ Flux Complet

```
1. Utilisateur se connecte ‚Üí /login/face
2. Upload une image au FaceAuthController
3. Laravel appelle l'API Python: https://vision-afrique-ethique-python3.onrender.com/face/tokenize
4. L'API retourne: {token, age, gender, embedding}
5. Laravel stocke dans Supabase PostgreSQL
6. Utilisateur authentifi√© ‚úÖ
```

---

## üìå Points Cl√©s

| Point | Solution |
|-------|----------|
| **Donn√©es persistantes** | PostgreSQL Supabase (pas SQLite qui dispara√Æt) |
| **Cache/Sessions** | Redis (inclus dans docker-compose) |
| **API Python** | Accessible via `http://faceauth-api:8000` en local, HTTPS en production |
| **Secrets** | `.env.production` avec les vrais values de Supabase |
| **Migrations** | `docker-compose exec laravel php artisan migrate` |
| **Seeders** | `docker-compose exec laravel php artisan db:seed` |

---

## ‚úÖ Checklist Avant Deploy

- [ ] Dockerfile cr√©√©
- [ ] docker-compose.yml cr√©√©
- [ ] .dockerignore cr√©√©
- [ ] .env.production avec secrets Supabase
- [ ] Migrations √©crites (`php artisan make:migration`)
- [ ] Seeders √©crits (`php artisan make:seeder`)
- [ ] Tests locaux OK (`docker-compose up -d`)
- [ ] GitHub repo √† jour
- [ ] Render connect√© et configur√©
- [ ] Supabase projet cr√©√© avec les bonnes valeurs


===========================================================


Excellent ! Tu as tout bien organis√©. Je vais te cr√©er les fichiers Docker + Supabase complets. üöÄVoil√† ! üéØ J'ai cr√©√© un guide complet **Laravel + Docker + Supabase**.

## üéì Explications cl√©s

### **Pourquoi cette archi ?**

1. **Dockerfile Alpine PHP** = l√©ger (~200MB au lieu de 1GB)
2. **docker-compose** orchestrer 3 services : Laravel, Redis, API Python
3. **Supabase PostgreSQL** = donn√©es persistent (pas SQLite qui dispara√Æt)
4. **Redis** = cache ultra-rapide + sessions distribu√©es
5. **L'API Python** = accessible directement en local comme `http://faceauth-api:8000` !

### **Le Flux en Production**

```
User POST /login/face (image)
  ‚Üì
Laravel Controller re√ßoit
  ‚Üì
Appelle API Python: https://vision-afrique-ethique-python3.onrender.com/face/tokenize
  ‚Üì
R√©cup√®re {token, age, gender, embedding}
  ‚Üì
Stocke dans Supabase PostgreSQL
  ‚Üì
User authentifi√© ‚úÖ
```

---

## üìã Maintenant √† toi de jouer !

1. **Cr√©e les 4 fichiers** (Dockerfile, docker-compose.yml, .env.production, .dockerignore)
2. **Configure Supabase** et r√©cup√®re tes credentials
3. **Teste en local** : `docker-compose up -d`
4. **Fais tes migrations/seeders**
5. **Push sur GitHub**
6. **Deploy sur Render**

Des questions ? Je peux t'aider pour :
- Les migrations ? 
- Les seeders ?
- La config Supabase ?
- Le d√©ploiement Render ?

On y va ? üöÄ